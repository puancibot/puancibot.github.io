<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <style>
    :root { --bg-color: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --text-color: #f8fafc; --accent-color: #38bdf8; --gold: #fbbf24; --silver: #94a3b8; --bronze: #b45309; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, var(--bg-color) 70%); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 40px 20px; }
    h1 { margin: 10px 0; font-weight: 800; font-size: 2.5rem; text-transform: uppercase; letter-spacing: 3px; text-align: center; background: linear-gradient(135deg, #fff 0%, #38bdf8 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    .info-text { color: #94a3b8; font-size: 0.9rem; text-align: center; max-width: 600px; font-weight: 500; }
    #username-search { width: 100%; max-width: 400px; padding: 10px 15px; margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; background-color: rgba(30, 41, 59, 0.8); color: var(--text-color); font-size: 1rem; outline: none; transition: border-color 0.3s ease; }
    #username-search::placeholder { color: #94a3b8; }
    ul { list-style-type: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; width: 100%; max-width: 1200px; }
    li { background-color: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
    li:hover { transform: translateY(-8px) scale(1.02); background-color: rgba(30, 41, 59, 0.9); border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.6); }
    .rank-badge { position: absolute; top: 0; left: 0; background: rgba(15, 23, 42, 0.8); padding: 8px 12px; border-bottom-right-radius: 16px; font-weight: 800; font-size: 1rem; color: #fff; z-index: 10; border-right: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .avatar-wrapper { position: relative; width: 100%; height: 150px; border-radius: 16px; overflow: hidden; margin-bottom: 15px; display: flex; justify-content: center; align-items: flex-end; border: 2px solid transparent; }
    .avatar-wrapper::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url("https://cdn2.wolvesville.com/backgrounds/bp32_background_small_night@2x.png"); background-size: cover; background-position: center; filter: blur(6px); transform: scale(1.1); z-index: 0; }
    .avatar-wrapper::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.2); z-index: 1; }
    /* CSS'te varsayƒ±lan olarak contain kullanƒ±yoruz */
    .avatar-wrapper img { position: relative; z-index: 2; width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); transition: transform 0.3s ease; }
    li:hover .avatar-wrapper img { transform: scale(1.05); }
    .username { font-weight: 700; font-size: 1.15rem; margin-bottom: 8px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; letter-spacing: 0.5px; }
    .score { font-size: 0.95rem; color: var(--text-color); background: linear-gradient(90deg, rgba(56, 189, 248, 0.2) 0%, rgba(56, 189, 248, 0.05) 100%); padding: 6px 16px; border-radius: 8px; font-weight: 600; border: 1px solid rgba(56, 189, 248, 0.3); width: 100%; text-align: center; box-sizing: border-box; }
    li.rank-1 { border-color: var(--gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.15); background: linear-gradient(to bottom right, rgba(251, 191, 36, 0.1), rgba(30, 41, 59, 0.8)); }
    li.rank-1 .avatar-wrapper { border-color: var(--gold); } li.rank-1 .rank-badge { background-color: var(--gold); color: #000; } li.rank-1 .score { background: rgba(251, 191, 36, 0.2); border-color: var(--gold); color: var(--gold); }
    li.rank-2 { border-color: var(--silver); } li.rank-2 .avatar-wrapper { border-color: var(--silver); } li.rank-2 .rank-badge { background-color: var(--silver); color: #000; }
    li.rank-3 { border-color: var(--bronze); } li.rank-3 .avatar-wrapper { border-color: var(--bronze); } li.rank-3 .rank-badge { background-color: var(--bronze); color: #fff; }
    .grecaptcha-badge { visibility: hidden;}
    a{ color: var(--accent-color); text-decoration: none; }
    @media (max-width: 600px) { h1 { font-size: 2rem; } ul { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); } li { padding: 10px; } .avatar-wrapper { height: 120px; } .username { font-size: 1rem; } }
  </style>
</head>
<body>
  
  <h1>üèÜ Lider Tablosu</h1>
  <p class="info-text">Not: Puanlar ger√ßek zamanlƒ± g√ºncellenir. 22.12.2025 sonrasƒ± ve sadece normal, realistic ve legacy mod avatar puanlamalarƒ± ge√ßerlidir.</p>
  <input type="text" id="username-search" value="" placeholder="Nick'e g√∂re ara.">
  <div id="error-message"></div>
  <ul id="lb"></ul>

  <small style="margin-top: 20px;color: #777;">This site is protected by reCAPTCHA and the Google 
      <a href="https://policies.google.com/privacy">Privacy Policy</a> and
      <a href="https://policies.google.com/terms">Terms of Service</a> apply.
  </small>


  <script src="https://www.google.com/recaptcha/api.js?render=6Le8zVQsAAAAAB6Uv1mK37EFTqW8sKgKzFU2RsIU"></script>
  <script>
    async function getCaptchaToken(action = "api_call") {
      return new Promise((resolve, reject) => {
        grecaptcha.ready(() => {
          grecaptcha.execute("6Le8zVQsAAAAAB6Uv1mK37EFTqW8sKgKzFU2RsIU", { action })
            .then(token => resolve(token))
            .catch(err => reject(err));
        });
      });
    }

    const searchInput = document.getElementById('username-search');
    searchInput.addEventListener('keydown', function(e) {
      if(e.key === 'Enter') {
        // Sayfayƒ± yeniden y√ºkleyerek arama sorgusunu g√ºncelle
        window.location.href = window.location.pathname + (searchInput.value ? "?q=" + encodeURIComponent(searchInput.value) : "");
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    searchInput.value = query || "";

    async function fetchLeaderboard() {
      const token = await getCaptchaToken("send_message");

      fetch("https://getleaderboard-khfbwz2saa-uc.a.run.app/" + (query ? "?q=" + encodeURIComponent(query) : ""), {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "X-Captcha-Token": token
          }
      })
        .then(r => r.json())
        .then(data => {
          if(data.length === 0) {
            document.getElementById("error-message").innerHTML = "<p style='color:#fbbf24; text-align:center;'>Puanlama bulunamadƒ±.</p>";
          } else {
            document.getElementById("error-message").innerHTML = "";
          }

          const ul = document.getElementById("lb");
          data.sort((a, b) => b.score - a.score);

          data.forEach((item, index) => {
            const li = document.createElement("li");
            const rank = index + 1;
            
            if (rank === 1) li.classList.add("rank-1");
            else if (rank === 2) li.classList.add("rank-2");
            else if (rank === 3) li.classList.add("rank-3");

            // Dƒ∞KKAT: img etiketine 'onload' olayƒ±nƒ± ekliyoruz.
            // Bu olay, resim y√ºklendiƒüinde 'adjustImageFit' fonksiyonunu √ßaƒüƒ±racak.
            li.innerHTML = `
              <div class="rank-badge">#${rank}</div>
              <div class="avatar-wrapper">
                  <img 
                      src="${item.avatarUrl}" 
                      alt="${item.username}" 
                      loading="lazy"
                      onload="adjustImageFit(this)" 
                  >
              </div>
              <div class="username">${item.username}</div>
              <div class="score">${item.score} PUAN</div>
            `;
            
            ul.appendChild(li);
          });
        })
        .catch(err => {
          console.error("Veri √ßekilemedi:", err);
          document.getElementById("error-message").innerHTML = "<p style='color:red; text-align:center;'>Veri y√ºklenirken hata olu≈ütu.</p>";
        });
      } fetchLeaderboard();
  </script>

  <script>
    // Bu fonksiyon her bir resim y√ºklendiƒüinde (onload) √ßalƒ±≈üƒ±r.
    // 'imgElement' o an y√ºklenen resimdir.
    function adjustImageFit(imgElement) {
        // Resmin orijinal (doƒüal) geni≈ülik ve y√ºksekliƒüini alƒ±yoruz.
        const naturalWidth = imgElement.naturalWidth;
        const naturalHeight = imgElement.naturalHeight;

        // E≈üik deƒüeri belirliyoruz. Eƒüer geni≈ülik, y√ºkseklikten %20 (1.2 katƒ±) daha fazlaysa,
        // bu resmi "geni≈ü" (wide) olarak kabul ediyoruz. Bu oranƒ± deƒüi≈ütirebilirsin.
        if (naturalWidth > naturalHeight * 1.3) {
            // Geni≈ü resimler i√ßin object-fit'i 'cover' yapƒ±yoruz.
            // B√∂ylece resim kutuyu tamamen dolduracak ≈üekilde kƒ±rpƒ±lƒ±r.
            imgElement.style.objectFit = 'cover';
        } 
        // Deƒüilse, CSS'teki varsayƒ±lan 'contain' deƒüeri ge√ßerli kalƒ±r.
        // (Bu y√ºzden bir 'else' bloƒüuna gerek yok).
    }
  </script>

  

</body>
</html>
