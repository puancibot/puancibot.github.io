<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <style>
    :root { 
        --bg-color: #0f172a; 
        --card-bg: rgba(30, 41, 59, 0.95); /* Blur yerine daha opak renk */
        --text-color: #f8fafc; 
        --accent-color: #38bdf8; 
        --gold: #fbbf24; 
        --silver: #94a3b8; 
        --bronze: #b45309; 
    }
    
    /* Genel Performans Ayarƒ± */
    * { box-sizing: border-box; }

    body { 
        font-family: 'Poppins', sans-serif; 
        background-color: var(--bg-color); 
        /* Gradyanƒ± basitle≈ütirdik */
        background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, var(--bg-color) 70%); 
        color: var(--text-color); 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 20px 10px; /* Mobilde padding azaltƒ±ldƒ± */
    }

    h1 { 
        margin: 10px 0; 
        font-weight: 800; 
        font-size: 2rem; 
        text-transform: uppercase; 
        letter-spacing: 2px; 
        text-align: center; 
        background: linear-gradient(135deg, #fff 0%, #38bdf8 100%); 
        -webkit-background-clip: text; 
        background-clip: text; 
        -webkit-text-fill-color: transparent; 
        /* Mobilde text-shadow performansƒ± d√º≈ü√ºrebilir, azalttƒ±k */
        text-shadow: 0 5px 10px rgba(0,0,0,0.3); 
    }

    .info-text { color: #94a3b8; font-size: 0.85rem; text-align: center; max-width: 600px; font-weight: 500; margin-bottom: 15px; }

    #username-search { 
        width: 100%; 
        max-width: 400px; 
        padding: 12px 15px; 
        margin-bottom: 25px; 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        border-radius: 12px; 
        background-color: rgba(30, 41, 59, 0.8); 
        color: var(--text-color); 
        font-size: 1rem; 
        outline: none; 
    }

    ul { 
        list-style-type: none; 
        padding: 0; 
        margin: 0; 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Mobilde daha √ßok sƒ±ƒüsƒ±n diye 160px */
        gap: 15px; 
        width: 100%; 
        max-width: 1200px;
        /* Render performansƒ±nƒ± artƒ±rƒ±r */
        contain: content;
    }

    li { 
        background-color: var(--card-bg); 
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08); 
        border-radius: 16px; 
        padding: 10px; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        position: relative; 
        overflow: hidden; 
        /* GPU hƒ±zlandƒ±rma i√ßin */
        transform: translateZ(0);
        will-change: transform;
    }

    .rank-badge { 
        position: absolute; 
        top: 0; 
        left: 0; 
        background: rgba(15, 23, 42, 0.9); 
        padding: 6px 10px; 
        border-bottom-right-radius: 12px; 
        font-weight: 800; 
        font-size: 0.9rem; 
        color: #fff; 
        z-index: 10; 
    }

    .avatar-wrapper { 
        position: relative; 
        width: 100%; 
        height: 120px; 
        border-radius: 12px; 
        overflow: hidden; 
        margin-bottom: 10px; 
        display: flex; 
        justify-content: center; 
        align-items: flex-end; 
        border: 2px solid transparent; 
        background-color: #0f172a; /* Resim y√ºklenene kadar bo≈üluk */
    }

    /* Arka plan g√∂rseli optimizasyonu */
    .avatar-wrapper::before { 
        content: ''; 
        position: absolute; 
        top: 0; left: 0; right: 0; bottom: 0; 
        /* Resmi tek seferde y√ºklemesi i√ßin tarayƒ±cƒ± cache kullanƒ±r */
        background-image: url("https://cdn2.wolvesville.com/backgrounds/bp32_background_small_night@2x.png"); 
        background-size: cover; 
        background-position: center;
        filter: blur(6px);
        opacity: 0.6;
        z-index: 0; 
    }
    
    .avatar-wrapper::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.4), transparent); z-index: 1; }

    .avatar-wrapper img { 
        position: relative; 
        z-index: 2; 
        width: 100%; 
        height: 100%; 
        object-fit: contain; 
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); 
        transition: transform 0.2s ease;
        /* Layout shift engellemek i√ßin */
        display: block;
    }

    .username { 
        font-weight: 700; 
        font-size: 1rem; 
        margin-bottom: 6px; 
        text-align: center; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        max-width: 100%; 
        color: #e2e8f0;
    }

    .score { 
        font-size: 0.85rem; 
        color: var(--text-color); 
        background: rgba(56, 189, 248, 0.1); 
        padding: 4px 10px; 
        border-radius: 6px; 
        font-weight: 600; 
        border: 1px solid rgba(56, 189, 248, 0.2); 
        width: 100%; 
        text-align: center; 
    }

    /* Rank √ñzel Stilleri - Performans i√ßin basitle≈ütirildi */
    li.rank-1 { border-color: var(--gold); background: linear-gradient(145deg, rgba(251, 191, 36, 0.05), rgba(30, 41, 59, 0.9)); }
    li.rank-1 .avatar-wrapper { border-color: var(--gold); } 
    li.rank-1 .rank-badge { background-color: var(--gold); color: #000; } 
    li.rank-1 .score { background: rgba(251, 191, 36, 0.15); border-color: var(--gold); color: var(--gold); }

    li.rank-2 { border-color: var(--silver); } 
    li.rank-2 .avatar-wrapper { border-color: var(--silver); } 
    li.rank-2 .rank-badge { background-color: var(--silver); color: #000; }

    li.rank-3 { border-color: var(--bronze); } 
    li.rank-3 .avatar-wrapper { border-color: var(--bronze); } 
    li.rank-3 .rank-badge { background-color: var(--bronze); color: #fff; }

    .grecaptcha-badge { visibility: hidden;}
    a { color: var(--accent-color); text-decoration: none; }

    /* Mobilde Grid Ayarƒ± */
    @media (min-width: 600px) {
        ul { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .avatar-wrapper { height: 140px; }
        .username { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  
  <h1>üèÜ Lider Tablosu</h1>
  <p class="info-text">Not: Puanlar ger√ßek zamanlƒ± g√ºncellenir. 22.12.2025 sonrasƒ± puanlamalar ge√ßerlidir. <br> Ve sadece normal, realistic ve legacy mod puanlarƒ± kaydediliyor.</p>
  <input type="text" id="username-search" value="" placeholder="Nick'e g√∂re ara..." aria-label="Kullanƒ±cƒ± Ara">
  <div id="error-message"></div>
  <ul id="lb"></ul>

  <small style="margin-top: 20px;color: #777;">This site is protected by reCAPTCHA and the Google 
      <a href="https://policies.google.com/privacy">Privacy Policy</a> and
      <a href="https://policies.google.com/terms">Terms of Service</a> apply.
  </small>

  <script src="https://www.google.com/recaptcha/api.js?render=6Le8zVQsAAAAAB6Uv1mK37EFTqW8sKgKzFU2RsIU" async defer></script>
  <script>
    const API_URL = "https://getleaderboard-khfbwz2saa-lz.a.run.app/";
    const SITE_KEY = "6Le8zVQsAAAAAB6Uv1mK37EFTqW8sKgKzFU2RsIU";

    async function getCaptchaToken(action = "api_call") {
      return new Promise((resolve, reject) => {
        if (typeof grecaptcha === 'undefined') {
            reject("reCAPTCHA y√ºklenmedi.");
            return;
        }
        grecaptcha.ready(() => {
          grecaptcha.execute(SITE_KEY, { action })
            .then(token => resolve(token))
            .catch(err => reject(err));
        });
      });
    }

    const searchInput = document.getElementById('username-search');
    
    // Enter tu≈üu ile arama
    searchInput.addEventListener('keydown', function(e) {
      if(e.key === 'Enter') {
        const val = searchInput.value.trim();
        window.location.href = window.location.pathname + (val ? "?q=" + encodeURIComponent(val) : "");
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if(query) searchInput.value = query;

    async function fetchLeaderboard() {
      // Y√ºkleniyor mesajƒ± (isteƒüe baƒülƒ± eklenebilir) veya placeholder
      
      try {
        const token = await getCaptchaToken("send_message");
        const fetchUrl = API_URL + (query ? "?q=" + encodeURIComponent(query) : "");

        const response = await fetch(fetchUrl, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-Captcha-Token": token
            }
        });

        if (!response.ok) throw new Error("API Hatasƒ±");

        const data = await response.json();
        const ul = document.getElementById("lb");
        const errorMessage = document.getElementById("error-message");

        if(data.length === 0) {
           errorMessage.innerHTML = "<p style='color:#fbbf24; text-align:center;'>Puanlama bulunamadƒ±.</p>";
           ul.innerHTML = "";
           return;
        } else {
           errorMessage.innerHTML = "";
        }

        // DOM Manip√ºlasyonu Optimizasyonu: DocumentFragment kullan
        const fragment = document.createDocumentFragment();
        
        // Sƒ±ralama
        data.sort((a, b) => b.score - a.score);

        data.forEach((item, index) => {
          const li = document.createElement("li");
          const rank = index + 1;
          
          if (rank === 1) li.className = "rank-1";
          else if (rank === 2) li.className = "rank-2";
          else if (rank === 3) li.className = "rank-3";

          // JS ile resim d√ºzeltme yerine standart yapƒ±
          li.innerHTML = `
            <div class="rank-badge">#${rank}</div>
            <div class="avatar-wrapper">
                <img 
                    src="${item.avatarUrl}" 
                    alt="${item.username}" 
                    loading="lazy"
                    width="150" height="150"
                    onload="adjustImageFit(this)"
                >
            </div>
            <div class="username">${item.username}</div>
            <div class="score">${item.score} PUAN</div>
          `;
          
          fragment.appendChild(li);
        });

        // Tek seferde DOM'a yaz
        ul.innerHTML = ""; 
        ul.appendChild(fragment);

      } catch (err) {
        console.error("Hata:", err);
        document.getElementById("error-message").innerHTML = "<p style='color:red; text-align:center;'>Veri y√ºklenirken hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.</p>";
      }
    } 

    let attempts = 0;
    const maxAttempts = 50; // 5 saniye bekle (50 * 100ms)

    const checkRecaptcha = setInterval(() => {
        attempts++;
        // grecaptcha nesnesi tarayƒ±cƒ±ya y√ºklendi mi kontrol et
        if (typeof grecaptcha !== 'undefined') {
            clearInterval(checkRecaptcha);
            console.log("Recaptcha y√ºklendi, veri √ßekiliyor...");
            fetchLeaderboard();
        } else if (attempts >= maxAttempts) {
            clearInterval(checkRecaptcha);
            document.getElementById("error-message").innerHTML = 
                "<p style='color:red; text-align:center;'>Google Recaptcha y√ºklenemedi. L√ºtfen reklam engelleyici (AdBlock) varsa kapatƒ±p sayfayƒ± yenileyin.</p>";
        }
    }, 100); // 100ms'de bir kontrol et

    function adjustImageFit(imgElement) {
        const naturalWidth = imgElement.naturalWidth;
        const naturalHeight = imgElement.naturalHeight;
        if (naturalWidth > naturalHeight * 1.3) {
            imgElement.style.objectFit = 'cover';
        } 
    }
  </script>
</body>
</html>

